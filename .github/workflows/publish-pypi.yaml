name: Publish to PyPI
on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
permissions:
  id-token: write # Required for PyPI OIDC
jobs:
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/beautysh
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      - name: Setup Cachix
        uses: cachix/cachix-action@v16
        with:
          name: beautysh
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Build package
        run: nix develop -c python -m build
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
